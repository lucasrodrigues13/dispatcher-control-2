name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite execução manual

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e  # Parar em caso de erro
            
            echo "=========================================="
            echo "INICIANDO DEPLOY"
            echo "=========================================="
            echo ""
            
            # Navegar para o diretório da aplicação
            cd /var/www/dispatcher-control
            
            # 1. Fazer pull das mudanças
            echo "[1/12] Fazendo git pull..."
            git pull origin main
            echo ""
            
            # 2. Verificar e instalar dependências
            echo "[2/12] Verificando dependências..."
            composer install --no-dev --optimize-autoloader --no-interaction --quiet
            echo ""
            
            # 3. Verificar migrations pendentes antes de executar
            echo "[3/12] Verificando migrations pendentes..."
            MIGRATIONS_PENDING=$(php artisan migrate:status | grep -c "Pending" || echo "0")
            echo "  → Migrations pendentes: $MIGRATIONS_PENDING"
            echo ""
            
            # 3.1. Executar migrations
            echo "[4/12] Executando migrations..."
            php artisan migrate --force
            echo ""
            
            # 3.2. Verificar se precisa rodar seeds (apenas se houver mudanças)
            echo "[5/12] Verificando se precisa executar seeds..."
            SEED_NEEDED=false
            
            # Verificar se há arquivos de migration ou seeder modificados no último commit
            if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -E "(database/migrations|database/seeders)" > /dev/null; then
                SEED_NEEDED=true
                echo "  → Arquivos de migration/seeder modificados detectados"
            fi
            
            # Se havia migrations pendentes, provavelmente precisa rodar seeds
            if [ "$MIGRATIONS_PENDING" -gt 0 ]; then
                SEED_NEEDED=true
                echo "  → Novas migrations foram executadas"
            fi
            
            if [ "$SEED_NEEDED" = true ]; then
                echo "  → Executando seeds..."
                php artisan db:seed --force
            else
                echo "  → Nenhuma alteração detectada, pulando seeds"
            fi
            echo ""
            
            # 6. Limpar TODOS os caches
            echo "[6/12] Limpando caches..."
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            php artisan event:clear
            echo ""
            
            # 7. Recriar cache de rotas
            echo "[7/12] Recriando cache de rotas..."
            php artisan route:cache
            echo ""
            
            # 8. Recriar cache de configuração
            echo "[8/12] Recriando cache de configuração..."
            php artisan config:cache
            echo ""
            
            # 9. Otimizar aplicação
            echo "[9/12] Otimizando aplicação..."
            php artisan optimize
            echo ""
            
            # 10. Verificar e corrigir permissões
            echo "[10/12] Verificando permissões..."
            chown -R www-data:www-data storage bootstrap/cache
            chmod -R 775 storage bootstrap/cache
            echo ""
            
            # 11. Configurar e iniciar queue worker como serviço systemd
            echo "[11/12] Configurando queue worker..."
            
            SERVICE_FILE="/etc/systemd/system/laravel-queue-worker.service"
            
            # Verificar se o arquivo de serviço já existe
            if [ -f "$SERVICE_FILE" ]; then
                echo "  → Arquivo de serviço já existe, pulando criação"
            else
                echo "  → Criando arquivo de serviço: $SERVICE_FILE"
                
                # Verificar caminho do PHP
                PHP_PATH=$(which php || echo "/usr/bin/php")
                echo "  → PHP path: $PHP_PATH"
                
                # Criar arquivo de serviço systemd
                sudo bash -c "printf '%s\n' \
                  '[Unit]' \
                  'Description=Laravel Queue Worker' \
                  'After=network.target mysql.service' \
                  '' \
                  '[Service]' \
                  'Type=simple' \
                  'User=www-data' \
                  'Group=www-data' \
                  'WorkingDirectory=/var/www/dispatcher-control' \
                  'Restart=always' \
                  'RestartSec=10' \
                  'ExecStart=/usr/bin/php /var/www/dispatcher-control/artisan queue:work database --sleep=3 --tries=3 --max-time=3600 --timeout=300' \
                  'StandardOutput=journal' \
                  'StandardError=journal' \
                  '' \
                  '[Install]' \
                  'WantedBy=multi-user.target' > $SERVICE_FILE"
                
                # Ajustar caminho do PHP no arquivo de serviço
                sudo sed -i "s|ExecStart=/usr/bin/php|ExecStart=$PHP_PATH|g" $SERVICE_FILE
                
                # Recarregar systemd apenas se criou o arquivo
                sudo systemctl daemon-reload
                echo "  → ✅ Arquivo de serviço criado e systemd recarregado"
            fi
            
            # Habilitar serviço (inicia automaticamente no boot) - sempre executar
            sudo systemctl enable laravel-queue-worker 2>/dev/null || echo "  → Serviço já habilitado"
            
            # Iniciar ou reiniciar serviço
            if sudo systemctl is-active --quiet laravel-queue-worker 2>/dev/null; then
                echo "  → Queue worker já está rodando, reiniciando..."
                sudo systemctl restart laravel-queue-worker
            else
                echo "  → Iniciando queue worker..."
                sudo systemctl start laravel-queue-worker
            fi
            
            # Verificar status
            if sudo systemctl is-active --quiet laravel-queue-worker; then
                echo "  → ✅ Queue worker está ativo"
            else
                echo "  → ⚠️  Queue worker não está ativo, verifique logs: journalctl -u laravel-queue-worker"
            fi
            echo ""
            
            # Verificar jobs falhados
            FAILED_JOBS=$(php artisan queue:failed | grep -c "failed" || echo "0")
            if [ "$FAILED_JOBS" -gt 0 ]; then
                echo "⚠️  ATENÇÃO: $FAILED_JOBS job(s) falhado(s) encontrado(s)"
                echo "  → Execute: php artisan queue:failed para ver detalhes"
                echo "  → Execute: php artisan queue:retry all para tentar novamente"
            else
                echo "✅ Nenhum job falhado encontrado"
            fi
            echo ""
            
            echo "=========================================="
            echo "DEPLOY CONCLUÍDO COM SUCESSO!"
            echo "=========================================="
            echo ""
            echo "Verificando logs recentes para erros..."
            tail -n 20 storage/logs/laravel.log | grep -i error || echo "Nenhum erro encontrado nos logs recentes."

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd /var/www/dispatcher-control
            echo "=========================================="
            echo "VERIFICAÇÃO PÓS-DEPLOY"
            echo "=========================================="
            echo ""
            echo "Verificando status da aplicação..."
            php artisan about | head -10 || echo "Comando 'about' não disponível"
            echo ""
            echo "Verificando se o Apache está rodando..."
            systemctl is-active apache2 && echo "✅ Apache está ativo" || echo "❌ Apache não está ativo"
            echo ""
            echo "Verificando queue worker..."
            if systemctl is-active --quiet laravel-queue-worker 2>/dev/null; then
              echo "✅ Queue worker está ativo (systemd)"
              systemctl status laravel-queue-worker --no-pager | head -5
            elif pgrep -f "queue:work" > /dev/null; then
              echo "✅ Queue worker está rodando (processo)"
            else
              echo "⚠️  Queue worker NÃO está rodando"
              echo "   Execute: php artisan queue:work --tries=3 --daemon"
              echo "   Ou configure como serviço systemd (veja docs/QUEUE_MONITORING_TROUBLESHOOTING.md)"
            fi
            echo ""
            echo "Verificando jobs falhados..."
            FAILED_COUNT=$(php artisan queue:failed 2>/dev/null | grep -c "failed" || echo "0")
            if [ "$FAILED_COUNT" -gt 0 ]; then
              echo "⚠️  $FAILED_COUNT job(s) falhado(s) encontrado(s)"
              echo "   Execute: php artisan queue:failed para ver detalhes"
            else
              echo "✅ Nenhum job falhado"
            fi
            echo ""
            echo "Verificando migrations..."
            MIGRATIONS_STATUS=$(php artisan migrate:status 2>/dev/null | tail -1)
            echo "Status: $MIGRATIONS_STATUS"

