name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite execução manual

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e  # Parar em caso de erro
            
            echo "=========================================="
            echo "INICIANDO DEPLOY"
            echo "=========================================="
            echo ""
            
            # Navegar para o diretório da aplicação
            cd /var/www/dispatcher-control
            
            # 1. Fazer pull das mudanças
            echo "[1/9] Fazendo git pull..."
            git pull origin main
            echo ""
            
            # 2. Verificar e instalar dependências
            echo "[2/9] Verificando dependências..."
            composer install --no-dev --optimize-autoloader --no-interaction --quiet
            echo ""
            
            # 3. Verificar migrations pendentes antes de executar
            echo "[3/9] Verificando migrations pendentes..."
            MIGRATIONS_PENDING=$(php artisan migrate:status | grep -c "Pending" || echo "0")
            echo "  → Migrations pendentes: $MIGRATIONS_PENDING"
            echo ""
            
            # 3.1. Executar migrations
            echo "[4/9] Executando migrations..."
            php artisan migrate --force
            echo ""
            
            # 3.2. Verificar se precisa rodar seeds (apenas se houver mudanças)
            echo "[5/9] Verificando se precisa executar seeds..."
            SEED_NEEDED=false
            
            # Verificar se há arquivos de migration ou seeder modificados no último commit
            if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -E "(database/migrations|database/seeders)" > /dev/null; then
                SEED_NEEDED=true
                echo "  → Arquivos de migration/seeder modificados detectados"
            fi
            
            # Se havia migrations pendentes, provavelmente precisa rodar seeds
            if [ "$MIGRATIONS_PENDING" -gt 0 ]; then
                SEED_NEEDED=true
                echo "  → Novas migrations foram executadas"
            fi
            
            if [ "$SEED_NEEDED" = true ]; then
                echo "  → Executando seeds..."
                php artisan db:seed --force
            else
                echo "  → Nenhuma alteração detectada, pulando seeds"
            fi
            echo ""
            
            # 6. Limpar TODOS os caches
            echo "[6/9] Limpando caches..."
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            php artisan event:clear
            echo ""
            
            # 7. Recriar cache de rotas
            echo "[7/9] Recriando cache de rotas..."
            php artisan route:cache
            echo ""
            
            # 8. Recriar cache de configuração
            echo "[8/9] Recriando cache de configuração..."
            php artisan config:cache
            echo ""
            
            # 9. Otimizar aplicação
            echo "[9/9] Otimizando aplicação..."
            php artisan optimize
            echo ""
            
            # 10. Verificar e corrigir permissões
            echo "[10/10] Verificando permissões..."
            chown -R www-data:www-data storage bootstrap/cache
            chmod -R 775 storage bootstrap/cache
            echo ""
            
            echo "=========================================="
            echo "DEPLOY CONCLUÍDO COM SUCESSO!"
            echo "=========================================="
            echo ""
            echo "Verificando logs recentes para erros..."
            tail -n 20 storage/logs/laravel.log | grep -i error || echo "Nenhum erro encontrado nos logs recentes."

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd /var/www/dispatcher-control
            echo "Verificando status da aplicação..."
            php artisan about | head -10 || echo "Comando 'about' não disponível"
            echo ""
            echo "Verificando se o Apache está rodando..."
            systemctl is-active apache2 && echo "✅ Apache está ativo" || echo "❌ Apache não está ativo"

